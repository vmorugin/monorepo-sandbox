# B2B Монорепа на python

## Содержание

Монорепа содержит в себе все сервисы, которые нужны для работы B2B. 
Каждый сервис представляет собой независимый модуль, который можно разворачивать и обновлять отдельно от остальных.
Для всех проектов монорепа создаёт единый uv.lock файл, в котором лежит вся мета-информация о зависимостях и сервисах.

Для общего пользования выделен проект _shared_. Его можно использовать во всех остальных сервисах,
если добавить его в зависимости в файле `pyproject.toml`.

## Быстрый старт

### Подготовка проекта

Всеми зависимостями управляет [uv](https://astral.sh/uv/).

Установить uv можно следующими способами (macos / linux):
* `$ curl -LsSf https://astral.sh/uv/install.sh | sh`
* `$ curl -LsSf https://astral.sh/uv/0.8.2/install.sh | sh` 
* `$ wget -qO- https://astral.sh/uv/install.sh | sh`

macOS:
* `brew install uv`

После установки в корне проекта клацаем:
* `uv sync`

Это создаст виртуальное окружение, подянет нужную версию python (если её нет) и установит project-зависимости.

### Добавление нового сервиса

Для того чтобы создать новый сервис нужно:

* `uv init <service_name>` - создаст новый сервис в папке `b2b-monorepo/<service_name>`.

Сервис добавится в members файла `pyproject.toml` и будет частью монорепы.

### Общие библиотеки

Флаг `--lib` позволяет создать библиотеку, которая будет доступна для использования в других сервисах:

* `uv init <library_name> --lib` - создаст новую библиотеку в папке `b2b-monorepo/shared/<library_name>`

В корневом `pyproject.toml` появится секция `members`:
```toml
[tool.uv.workspace]
members = [
    "<library_name>",
]
```

Чтобы использовать общую библиотеку в сервисе, нужно добавить её в зависимости сервиса:

```bash
cd b2b-monorepo/<service_name>
uv add <library_name>
```

В `pyproject.toml` сервиса появится секция 
```toml
dependencies = [
    "<library_name>",
]

[tool.uv.sources]
"<library_name>" = { workspace = true }
```

### Работа с зависимостями

Каждый сервис имеет свой файл `pyproject.toml`, с зависимостями для проекта.

Чтобы добавить зависимость в сервис нужно:

* Перейти в папку сервиса: `cd b2b-monorepo/<service_name>`
* Добавить зависимость: `uv add <dependency_name>`

Или добавить зависимость из корня проекта, передав флаг `--package`
* `uv add <dependency_name> --package <service_name>`

Это добавит зависимость в секцию `dependencies` файла `pyproject.toml` и установит её в виртуальное окружение.


## Ограничения

- Workspace не подходит для случаев, когда пакеты-участники имеют конфликтующие зависимости или требуется отдельное виртуальное окружение для каждого пакета. В таких ситуациях предпочтительнее использовать path dependencies, определяя каждый пакет как независимый проект и указывая зависимости через `tool.uv.sources` в pyproject.toml.
- Workspace применяет единое значение `requires-python` для всех пакетов, вычисляя пересечение всех значений. Если необходимо тестировать отдельный пакет на версии Python, не поддерживаемой остальными, потребуется устанавливать его в отдельное виртуальное окружение вручную.
- Python не обеспечивает изоляцию зависимостей, поэтому uv не может гарантировать, что пакет использует только объявленные зависимости. В частности, внутри workspace невозможно полностью предотвратить импорт зависимостей, объявленных в других пакетах workspace.
- При использовании независимых проектов с path dependencies появляется больше гибкости в управлении зависимостями и виртуальными окружениями, но становится недоступна команда `uv run --package` — запуск команд нужно осуществлять из соответствующей директории пакета.

Пример использования path dependencies:

```toml
[project]
name = "albatross"
version = "0.1.0"
requires-python = ">=3.12"
dependencies = ["bird-feeder", "tqdm>=4,<5"]

[tool.uv.sources]
bird-feeder = { path = "../packages/bird-feeder" }

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

